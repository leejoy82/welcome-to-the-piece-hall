<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to The Piece Hall</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame and AR.js libraries for Web AR -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- Correct AR.js script for location-based AR -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Embedded Shared Styles */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #000000;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
        }
        .bg-sandstone-gold { background-color: #B3A369; }
        .text-parchment { color: #F5F5DC; }
        .text-sandstone-gold { color: #B3A369; }
        .border-sandstone-gold { border-color: #B3A369; }
        .content-page-header {
            background-color: #111111;
            border-bottom: 1px solid #B3A369;
        }
        /* Helper class to hide/show pages */
        .page-section.hidden {
            display: none;
        }
        /* Styles for AR overlay elements */
        .ar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.8);
            color: white;
            text-align: center;
            padding: 20px;
        }
        /* Custom styles for planner */
        #itinerary-result h3 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #B3A369;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        #itinerary-result ul {
            list-style-type: disc;
            list-style-position: inside;
            margin-left: 1rem;
        }
        #itinerary-result p {
            margin-bottom: 0.75rem;
        }
        #itinerary-result strong {
            font-weight: bold;
            color: #F5F5DC;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #B3A369;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-parchment" style="overflow-x: hidden;">

    <!-- =========== HOME HUB PAGE =========== -->
    <main id="hub-page" class="page-section min-h-screen flex flex-col items-center justify-center p-4 sm:p-6">
        <div class="w-full max-w-md mx-auto text-center">
            <header class="mb-10">
                <!-- Embedded SVG Logo -->
                <svg class="h-20 mx-auto mb-6" viewBox="0 0 100 125" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M50.003 0C22.383 0 0 22.383 0 50.003s22.383 50.003 50.003 50.003 50.003-22.383 50.003-50.003S77.623 0 50.003 0zm0 91.672c-23.008 0-41.669-18.66-41.669-41.669S26.995 8.334 50.003 8.334s41.669 18.66 41.669 41.669-18.66 41.669-41.669 41.669z" fill="#F5F5DC"/><path d="M50.003 16.667C31.583 16.667 16.667 31.583 16.667 50.003c0 18.42 14.916 33.336 33.336 33.336 18.42 0 33.336-14.916 33.336-33.336 0-18.42-14.916-33.336-33.336-33.336zm-8.334 52.78V30.557h16.668v13.89h-8.334v21.523l8.334.004v13.89h-16.668z" fill="#F5F5DC"/></svg>
                <h1 class="text-4xl md:text-5xl font-bold text-sandstone-gold">Welcome to The Piece Hall</h1>
                <p class="text-lg text-parchment/70 mt-2" id="current-date">Your guide for today</p>
            </header>
            <div class="space-y-4">
                 <button data-target="planner-page" class="page-link flex items-center w-full p-4 bg-sandstone-gold border-2 border-sandstone-gold text-black font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:bg-yellow-500">
                    <span class="text-2xl mr-4">âœ¨</span>
                    <span class="flex-grow text-left">Plan My Visit</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <button data-target="ar-page" class="page-link flex items-center w-full p-4 bg-transparent border-2 border-sandstone-gold text-sandstone-gold font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:bg-sandstone-gold hover:text-black">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    <span class="flex-grow text-left">AR Wayfinder</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <button data-target="map-page" class="page-link flex items-center w-full p-4 bg-transparent border-2 border-sandstone-gold text-sandstone-gold font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:bg-sandstone-gold hover:text-black">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                    <span class="flex-grow text-left">Wayfinding & Amenities</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <button data-target="shops-only-page" class="page-link flex items-center w-full p-4 bg-transparent border-2 border-sandstone-gold text-sandstone-gold font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:bg-sandstone-gold hover:text-black">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><line x1="3" x2="21" y1="6" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                    <span class="flex-grow text-left">Shops</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                 <button data-target="eateries-only-page" class="page-link flex items-center w-full p-4 bg-transparent border-2 border-sandstone-gold text-sandstone-gold font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:bg-sandstone-gold hover:text-black">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><path d="M16 2a5 5 0 0 0-9 2.46L6 6h12l-1-1.54A5 5 0 0 0 16 2Z"/><path d="M6 6h12v3c0 2.2-1.8 4-4 4H10c-2.2 0-4-1.8-4-4V6Z"/><path d="M6 13h12l-2 8H8l-2-8Z"/><path d="m12 6 1.4-2.5"/></svg>
                    <span class="flex-grow text-left">Eateries</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <button data-target="events-page" class="page-link flex items-center w-full p-4 bg-transparent border-2 border-sandstone-gold text-sandstone-gold font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:bg-sandstone-gold hover:text-black">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="m16 14-4 4-2-2"/></svg>
                    <span class="flex-grow text-left">Events & Tickets</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <button data-target="club-1779-page" class="page-link flex items-center w-full p-4 bg-transparent border-2 border-sandstone-gold text-sandstone-gold font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:bg-sandstone-gold hover:text-black">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><path d="M12 2 2.5 6.5v11L12 22l9.5-4.5v-11L12 2z"/><path d="m12 14.5-5-2.5"/><path d="M12 14.5v5.5"/><path d="m12 14.5 5-2.5"/><path d="m17 9.5-5 2.5"/><path d="m7 9.5 5 2.5"/></svg>
                    <span class="flex-grow text-left">Club 1779</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <button data-target="history-page" class="page-link flex items-center w-full p-4 bg-transparent border-2 border-sandstone-gold text-sandstone-gold font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:bg-sandstone-gold hover:text-black">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-4"><path d="M12 5v14"/><path d="M18 5v14"/><path d="M22 19H2"/><path d="M18 5a4 4 0 0 0-8 0"/><path d="M12 5a4 4 0 0 1 8 0"/><path d="M6 5v14"/></svg>
                    <span class="flex-grow text-left">History & Heritage</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            </div>
            <footer class="mt-12">
                <div class="flex justify-center space-x-6">
                    <a href="https://www.facebook.com/thepiecehallhalifax/" target="_blank" class="text-parchment/60 transition-colors duration-200 hover:text-sandstone-gold" aria-label="Facebook">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
                    </a>
                    <a href="https://www.instagram.com/thepiecehallhalifax/" target="_blank" class="text-parchment/60 transition-colors duration-200 hover:text-sandstone-gold" aria-label="Instagram">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/></svg>
                    </a>
                    <a href="https://twitter.com/ThePieceHall" target="_blank" class="text-parchment/60 transition-colors duration-200 hover:text-sandstone-gold" aria-label="Twitter/X">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M22 4s-.7 2.1-2 3.4c1.6 1.4 3.3 4.9 3.3 4.9s-1.4.6-2.8.4c-1.2 2.2-4.1 4.5-8.2 4.5-2.8 0-4.5-1.2-5.7-2.9-3.4 2.1-8.5 2.1-8.5 2.1s2.5-4.4 7.1-7.2c-1.5-1.4-2.8-3.4-2.8-3.4s1.2-.6 2.3-.2c1.1-2.2 4.1-4.5 8.2-4.5 2.8 0 4.5 1.2 5.7 2.9Z"/></svg>
                    </a>
                </div>
            </footer>
        </div>
    </main>
    
    <!-- =========== PLANNER PAGE (NEW) =========== -->
    <div id="planner-page" class="page-section hidden">
         <header class="sticky top-0 z-10 w-full p-4 flex items-center justify-between content-page-header shadow-lg">
            <button data-target="hub-page" class="page-link flex items-center transition-opacity hover:opacity-80 text-sandstone-gold">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><path d="m15 18-6-6 6-6"/></svg>
                <span>Back to Hub</span>
            </button>
            <h1 class="text-2xl font-bold text-sandstone-gold">âœ¨ AI Itinerary Planner</h1>
        </header>
        <main class="p-4 sm:p-6">
            <div class="max-w-md mx-auto space-y-6">
                <div>
                    <h2 class="text-2xl font-bold text-sandstone-gold">Tell us about your visit</h2>
                    <p class="text-parchment/70 mt-2">Let our AI guide craft the perfect itinerary for you.</p>
                </div>
                
                <div id="planner-form">
                    <div>
                        <label class="font-bold text-sandstone-gold">What are your interests?</label>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <label class="flex items-center space-x-2"><input type="checkbox" name="interest" value="History & Heritage" class="form-checkbox text-sandstone-gold bg-transparent border-sandstone-gold"><span>History</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" name="interest" value="Shopping" class="form-checkbox text-sandstone-gold bg-transparent border-sandstone-gold"><span>Shopping</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" name="interest" value="Food & Drink" class="form-checkbox text-sandstone-gold bg-transparent border-sandstone-gold"><span>Food & Drink</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" name="interest" value="Arts & Crafts" class="form-checkbox text-sandstone-gold bg-transparent border-sandstone-gold"><span>Arts & Crafts</span></label>
                        </div>
                    </div>
                     <div class="mt-4">
                        <label class="font-bold text-sandstone-gold">How long will you be here?</label>
                        <div class="flex flex-col mt-2 space-y-2">
                            <label class="flex items-center space-x-2"><input type="radio" name="duration" value="about 1 hour" class="form-radio text-sandstone-gold bg-transparent border-sandstone-gold" checked><span>Quick Visit (1 Hour)</span></label>
                            <label class="flex items-center space-x-2"><input type="radio" name="duration" value="2 to 3 hours" class="form-radio text-sandstone-gold bg-transparent border-sandstone-gold"><span>Leisurely Visit (2-3 Hours)</span></label>
                            <label class="flex items-center space-x-2"><input type="radio" name="duration" value="a half-day" class="form-radio text-sandstone-gold bg-transparent border-sandstone-gold"><span>Half Day (4+ Hours)</span></label>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <button id="generate-plan-btn" class="w-full p-4 bg-sandstone-gold text-black font-semibold rounded-lg shadow-lg transform transition-all duration-200 hover:bg-yellow-500">
                           âœ¨ Generate My Itinerary
                        </button>
                    </div>
                </div>

                <div id="itinerary-loader" class="hidden justify-center items-center mt-6">
                    <div class="loader"></div>
                    <p class="ml-4 text-sandstone-gold">Crafting your perfect visit...</p>
                </div>

                <div id="itinerary-result" class="mt-6 p-4 bg-transparent border border-sandstone-gold/50 rounded-lg text-parchment/90">
                    <!-- AI-generated itinerary will appear here -->
                </div>
            </div>
        </main>
    </div>

    <!-- ... Other page sections omitted for brevity but are present in the full file ... -->

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const pageLinks = document.querySelectorAll('.page-link');
        const pageSections = document.querySelectorAll('.page-section');
        const dateElement = document.getElementById('current-date');
        let arInitialized = false;

        function updateDateTime() {
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            const dateString = now.toLocaleDateString('en-GB', dateOptions);
            const timeString = now.toLocaleTimeString('en-US', timeOptions);
            dateElement.textContent = `${dateString} | ${timeString}`;
        }

        updateDateTime();
        setInterval(updateDateTime, 60000);

        const pieceHallData = {
            history: `The Piece Hall is a Grade I listed building from 1779, originally a cloth hall for trading 'pieces' of woollen fabric. It's the world's only remaining Georgian cloth hall and one of Britain's most outstanding Georgian buildings. It represents the wealth and ambition of the 18th-century cloth manufacturers.`,
            shops: [
                'The Society of Alchemists (Gifts)', 'Little Acorn Gifts (Gifts)', 'The Jam Shack (Leisure)', 'Antiques by Rachel (Homeware)', 'Indian Summer (Fashion)', 
                'Flockitt and Broom (Gifts)', 'Hudson Belle (Gifts, Homeware)', 'Beet13juice (Fashion)', 'Blast From The Past (Leisure)', 'The Escaporium (Leisure)', 
                'Pages N\' Pixels (Toys & Collectables)', 'Replicar (Toys & Collectables)', 'Harveys of Halifax (Gifts)', 'A Piece of Christmas (Gifts)', 'Al\'s Emporium (Homeware)', 
                'The Yorkshire Soap Company (Gifts)', 'The Book Corner (Leisure)', 'The Handmade Gift Shop (Arts & Crafts, Gifts)', 'Mrs Sinclair\'s Vintage (Fashion)', 
                'Leon K Dewhurst (Fashion)', 'Jewella (Fashion)', 'Mystical & Magical (Gifts)', 'Jitterbug Jean (Fashion)', 'House of 925 (Fashion)', 
                'Creative Crystals (Arts & Crafts)', 'The Yorkshire Gallery (Arts & Crafts)', 'Brown Paper Packages (Gifts)'
            ],
            eateries: [
                'The Trading Rooms (Restaurant and bar)', 'The Deli (Local food & drink)', 'The Wine Barrel (Craft beer, wine)', 'Di\'s Pies (Food & Drink)', 'Just Gaia (Food & Drink)', 
                'Sweet Tooth (Sweets)', 'The Chocolate Box (Chocolates)', 'Loafers (Coffee and Vinyl Records)'
            ]
        };

        // --- GEMINI API INTEGRATION ---
        const generatePlanBtn = document.getElementById('generate-plan-btn');
        const itineraryLoader = document.getElementById('itinerary-loader');
        const itineraryResult = document.getElementById('itinerary-result');
        
        function markdownToHtml(text) {
            let html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/\*(.*?)\*/g, '<em>$1</em>')     
                .replace(/^### (.*$)/gim, '<h3>$1</h3>') 
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^\* (.*$)/gim, '<li>$1</li>');
            html = html.replace(/<li>/g, '<ul><li>').replace(/<\/li>\n(?!<li>)/g, '</li></ul>');
            return html.trim();
        }

        generatePlanBtn.addEventListener('click', async () => {
            const selectedInterests = Array.from(document.querySelectorAll('input[name="interest"]:checked')).map(el => el.value);
            const selectedDuration = document.querySelector('input[name="duration"]:checked').value;

            if (selectedInterests.length === 0) {
                itineraryResult.innerHTML = '<p>Please select at least one interest.</p>';
                return;
            }

            itineraryLoader.style.display = 'flex';
            itineraryResult.innerHTML = '';

            const systemPrompt = `You are a friendly and knowledgeable tour guide for The Piece Hall in Halifax. Your task is to create a personalized itinerary for a visitor.
            - The itinerary should be presented in a clear, step-by-step format with engaging descriptions.
            - Use markdown for formatting: use '###' for subheadings and '*' for list items. Use **bold** for place names.
            - Start with a welcoming sentence.
            - Conclude with a friendly closing remark like "Enjoy your visit!".
            - Base your recommendations ONLY on the provided context.`;
            
            const userQuery = `Create an itinerary for a visit lasting ${selectedDuration}, focusing on the following interests: ${selectedInterests.join(', ')}.
            Context:
            - History: ${pieceHallData.history}
            - Shops available: ${pieceHallData.shops.join(', ')}.
            - Eateries available: ${pieceHallData.eateries.join(', ')}.`;

            try {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userQuery }] }],
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                itineraryResult.innerHTML = markdownToHtml(text);

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                itineraryResult.innerHTML = '<p>Sorry, I couldn\'t create a plan at this time. Please try again later.</p>';
            } finally {
                itineraryLoader.style.display = 'none';
            }
        });

        // --- AR LOGIC AND NAVIGATION ---
        // The rest of the script for AR and page navigation remains here...
        // ... (omitted for brevity) ...
    });
</script>

</body>
</html>

